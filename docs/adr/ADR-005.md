# ADR-005: Search Strategy - Elasticsearch with PostgreSQL Fallback

## 1. Context

The platform requires a powerful and fast search experience, allowing users to find posts, comments, and other content. The search functionality must support full-text queries, advanced filtering (by community, author, date), faceting, and relevance scoring to deliver high-quality results. The solution must be scalable to handle a growing index of documents.

## 2. Decision

We will adopt a hybrid search strategy, using **Elasticsearch** as the primary engine for all user-facing search queries. Data will be asynchronously indexed into Elasticsearch from the primary PostgreSQL database via an event-driven mechanism (using MassTransit consumers).

**PostgreSQL's Full-Text Search (FTS)** will be maintained as a **fallback mechanism**. If the Elasticsearch cluster is unavailable, the API will transparently switch to querying PostgreSQL FTS to ensure service availability, albeit with potentially reduced performance and feature set.

## 3. Status

Accepted.

## 4. Consequences

### Positive ✅

*   **Advanced Search Capabilities**: Elasticsearch provides a rich query DSL, superior relevance tuning (TF-IDF, BM25), and advanced features like aggregations, faceting, and fuzzy matching that are difficult to achieve with a relational database alone.
*   **Performance and Scalability**: As a dedicated search engine, Elasticsearch is highly optimized for text-based queries and can be scaled horizontally, independent of the primary database, ensuring the search workload does not impact transactional performance.
*   **Decoupled Architecture**: Asynchronous indexing decouples the search service from the core application logic, improving resilience. An outage in the search cluster will not prevent users from creating new posts.
*   **High Availability**: The built-in fallback to PostgreSQL FTS provides a robust disaster recovery path, ensuring that a critical feature remains available even during a partial system outage.

### Negative ❌

*   **Increased Complexity**: This approach introduces another major component to the stack, which requires management, monitoring, and maintenance. Data consistency between PostgreSQL and Elasticsearch must be carefully managed.
*   **Data Latency**: Due to the asynchronous nature of indexing, there will be a small delay (typically seconds) before new content appears in search results. This is an acceptable trade-off for the vast majority of use cases on the platform.

## 5. Alternatives Considered

| Alternative                      | Rationale for Rejection                                                                                                                                                                                                                                                                                       |
| :------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **PostgreSQL FTS Only**          | While capable for basic full-text search, it lacks the advanced features, relevance tuning, and independent scalability of Elasticsearch. Relying on it solely would limit the quality of the search experience and place additional load on the primary database.                                               |
| **Other Search Engines (Meilisearch, Typesense)** | These are excellent, modern search engines that are often simpler to operate than Elasticsearch. However, Elasticsearch has a more mature ecosystem, deeper integration with tools like Grafana (via the ELK stack), and a wider feature set that may be valuable for future log analysis and observability needs. |
